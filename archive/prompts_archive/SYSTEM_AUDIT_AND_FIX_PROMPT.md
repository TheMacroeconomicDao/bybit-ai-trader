# 🔍 ПРОМПТ: Аудит и Исправление Аналитической Системы

## ЦЕЛЬ

Найти и исправить ВСЕ слабые места в аналитической системе, чтобы она:
- ✅ Находила **3 качественных LONG сигнала** по умолчанию
- ✅ Находила **4 качественных SHORT сигнала** по умолчанию
- ✅ Анализировала **СОТНИ активов**, а не 3-5
- ✅ Использовала **ВСЕ доступные инструменты** параллельно
- ✅ Применяла **многоуровневую фильтрацию** эффективно

---

## 🚨 КРИТИЧЕСКИЕ ПРОБЛЕМЫ (найдены в последнем анализе)

### Проблема 1: Поверхностный анализ
**Что было:**
- Проанализировано только 3 актива (BTC, ETH, SOL)
- Не использованы все инструменты поиска
- Не применена многоуровневая фильтрация

**Должно быть:**
- УРОВЕНЬ 1: Быстрый скрининг 200-500 активов
- УРОВЕНЬ 2: Средний анализ 50-100 активов
- УРОВЕНЬ 3: Детальный анализ 20-30 активов
- Финальный отбор: 3 LONG + 4 SHORT

### Проблема 2: Не используются все инструменты
**Что было:**
- Только `get_ticker`, `get_kline`, `get_ml_rsi`
- Не использованы: `scan_market`, `find_oversold_assets`, `find_breakout_opportunities`, `find_trend_reversals`

**Должно быть:**
- ПАРАЛЛЕЛЬНО запустить ВСЕ инструменты поиска
- Разные критерии для `scan_market` (oversold, overbought, breakouts, reversals)
- Использовать `get_market_overview` для полного обзора

### Проблема 3: Не ищутся SHORT возможности
**Что было:**
- Только LONG анализ
- Нет поиска overbought активов

**Должно быть:**
- ВСЕГДА искать В ОБЕ СТОРОНЫ
- `scan_market` с `direction: "short"` или `indicators: {"rsi_range": [65, 100]}`
- `find_overbought_assets()` для SHORT
- Приоритет SHORT если BTC в downtrend

### Проблема 4: Недостаточная фильтрация
**Что было:**
- Анализ остановился на первых 3 активах
- Нет ранжирования по confluence score

**Должно быть:**
- Многоуровневая фильтрация:
  - УРОВЕНЬ 1: Volume > $500K → 200-500 активов
  - УРОВЕНЬ 2: Score >= 6.0 → 50-100 активов
  - УРОВЕНЬ 3: Score >= 7.0 → 20-30 активов
  - ФИНАЛ: Score >= 8.0 → топ 3 LONG + топ 4 SHORT

---

## 📋 ЗАДАЧА АУДИТА

### ШАГ 1: Проверка всех доступных инструментов

**Проверить:**
1. Все ли MCP инструменты доступны и работают?
2. Правильно ли используются параметры?
3. Есть ли ограничения по limit, которые блокируют полный анализ?

**Действия:**
```
1.1. Проверить список всех доступных инструментов:
     → list_mcp_resources (если доступно)
     → Проверить документацию в .cursorrules
     
1.2. Протестировать каждый инструмент поиска:
     → scan_market с разными критериями
     → find_oversold_assets
     → find_overbought_assets
     → find_breakout_opportunities
     → find_trend_reversals
     → get_market_overview
     
1.3. Проверить лимиты:
     → Какие максимальные limit доступны?
     → Можно ли получить 200-500 активов?
```

### ШАГ 2: Анализ текущего протокола

**Проверить:**
1. Следует ли протокол из `prompts/market_analysis_protocol.md`?
2. Используется ли оптимизированная версия?
3. Правильно ли применяется многоуровневая фильтрация?

**Действия:**
```
2.1. Прочитать протокол:
     → prompts/market_analysis_protocol.md
     → prompts/market_analysis_protocol_optimized.md
     
2.2. Проверить соответствие:
     → Что требует протокол?
     → Что реально делается?
     → Где расхождения?
```

### ШАГ 3: Проверка scoring системы

**Проверить:**
1. Правильно ли рассчитывается confluence score?
2. Достаточно ли строгие критерии?
3. Почему не находятся сигналы с score >= 8.0?

**Действия:**
```
3.1. Проверить scoring в market_scanner.py:
     → _calculate_opportunity_score()
     → Какие факторы учитываются?
     → Какие веса у факторов?
     
3.2. Протестировать scoring:
     → Взять реальный актив
     → Рассчитать score вручную
     → Сравнить с результатом scan_market
```

### ШАГ 4: Проверка фильтрации

**Проверить:**
1. Правильно ли работает многоуровневая фильтрация?
2. Не отбрасываются ли качественные сигналы слишком рано?
3. Достаточно ли активов анализируется на каждом уровне?

**Действия:**
```
4.1. Проверить логику фильтрации:
     → УРОВЕНЬ 1: какие критерии?
     → УРОВЕНЬ 2: какие критерии?
     → УРОВЕНЬ 3: какие критерии?
     
4.2. Протестировать на реальных данных:
     → Запустить полный scan
     → Посмотреть сколько активов на каждом уровне
     → Проверить не теряются ли качественные сигналы
```

---

## 🔧 ИСПРАВЛЕНИЯ

### Исправление 1: Обязательное использование всех инструментов

**Добавить в протокол:**

```
ШАГ 1: ПАРАЛЛЕЛЬНЫЙ ЗАПУСК ВСЕХ ИНСТРУМЕНТОВ (ОБЯЗАТЕЛЬНО!)

1.1. Market Overview:
     → get_market_overview("spot") // Полный обзор
     → get_market_info("spot", limit=500) // Максимум активов
     
1.2. BTC анализ (первым):
     → get_ticker("BTCUSDT", "spot")
     → get_kline("BTCUSDT", "240", 50) // 4h
     → get_ml_rsi("BTCUSDT", "60", "spot") // 1h
     → get_market_structure("BTCUSDT", "240", "spot")
     
1.3. ПАРАЛЛЕЛЬНЫЙ поиск LONG (минимум 5 разных запросов):
     → scan_market({
         "market_type": "spot",
         "min_volume_24h": 1000000,
         "indicators": {"rsi_range": [0, 35]},
         "direction": "long"
       }, limit=50) // Oversold для LONG
       
     → scan_market({
         "market_type": "spot",
         "min_volume_24h": 1000000,
         "indicators": {"macd_crossover": "bullish"},
         "direction": "long"
       }, limit=50) // MACD bullish
       
     → scan_market({
         "market_type": "spot",
         "min_volume_24h": 1000000,
         "min_score": 7.0,
         "direction": "long"
       }, limit=50) // High score LONG
       
     → find_oversold_assets("spot", 1000000) // RSI <30
     → find_breakout_opportunities("spot", 1000000) // BB squeeze
     → find_trend_reversals("spot", 1000000) // Divergence
     
1.4. ПАРАЛЛЕЛЬНЫЙ поиск SHORT (минимум 5 разных запросов):
     → scan_market({
         "market_type": "spot",
         "min_volume_24h": 1000000,
         "indicators": {"rsi_range": [65, 100]},
         "direction": "short"
       }, limit=50) // Overbought для SHORT
       
     → scan_market({
         "market_type": "spot",
         "min_volume_24h": 1000000,
         "indicators": {"macd_crossover": "bearish"},
         "direction": "short"
       }, limit=50) // MACD bearish
       
     → scan_market({
         "market_type": "spot",
         "min_volume_24h": 1000000,
         "min_score": 7.0,
         "direction": "short"
       }, limit=50) // High score SHORT
       
     → find_overbought_assets("spot", 1000000) // RSI >70
     → find_breakout_opportunities("spot", 1000000) // Может быть SHORT breakout
     → find_trend_reversals("spot", 1000000) // Bearish reversal
```

**ИТОГО:** Минимум 12 параллельных запросов для поиска!

### Исправление 2: Многоуровневая фильтрация (обязательно!)

**Добавить в протокол:**

```
ШАГ 2: МНОГОУРОВНЕВАЯ ФИЛЬТРАЦИЯ

2.1. УРОВЕНЬ 1: Быстрый скрининг (200-500 активов)
     → Объединить ВСЕ результаты из ШАГ 1
     → Убрать дубликаты по symbol
     → Базовая фильтрация:
        - Volume >= $500K
        - Убрать активы без данных
     → ИТОГО: 200-500 уникальных активов
     
2.2. УРОВЕНЬ 2: Средний анализ (50-100 активов)
     → Для каждого из 200-500:
        - Использовать score из scan_market (если есть)
        - Если нет score → быстрый анализ через get_ticker + get_kline(1h)
        - Рассчитать preliminary confluence (0-10)
     → Фильтрация:
        - Score >= 6.0 (или preliminary confluence >= 6.0)
        - Volume >= $1M
        - Есть четкий setup
     → ИТОГО: 50-100 активов
     
2.3. УРОВЕНЬ 3: Детальный анализ (20-30 активов)
     → Для каждого из 50-100:
        - analyze_asset() на multi-TF (5m, 15m, 1h, 4h)
        - Полный confluence scoring
        - Проверка всех факторов
     → Фильтрация:
        - Score >= 7.0
        - Probability >= 65%
        - R:R >= 1:2
     → ИТОГО: 20-30 активов
     
2.4. ФИНАЛЬНЫЙ ОТБОР (3 LONG + 4 SHORT)
     → Ранжировать по score DESC
     → Отдельно для LONG и SHORT
     → Топ 3 LONG с score >= 8.0
     → Топ 4 SHORT с score >= 8.0
     → Если недостаточно с score >= 8.0:
        - LONG: взять лучшие до 3 (минимум score >= 7.5)
        - SHORT: взять лучшие до 4 (минимум score >= 7.5)
```

### Исправление 3: Обязательный поиск SHORT

**Добавить правило:**

```
⚠️ КРИТИЧЕСКИ ВАЖНО: ВСЕГДА искать В ОБЕ СТОРОНЫ!

Правило:
- Если BTC в uptrend → приоритет LONG, но искать SHORT тоже
- Если BTC в downtrend → приоритет SHORT, но искать LONG тоже
- Если BTC в ranging → равномерно искать ОБЕ СТОРОНЫ

Минимум результатов:
- LONG: 3 сигнала (score >= 8.0, или лучшие до 3 если нет)
- SHORT: 4 сигнала (score >= 8.0, или лучшие до 4 если нет)

Если не найдено достаточно:
→ Смягчить критерии до score >= 7.5
→ Но обязательно представить 3 LONG + 4 SHORT (или объяснить почему невозможно)
```

### Исправление 4: Улучшение scoring для нахождения сигналов

**Проверить и исправить:**

```
4.1. Проверить веса факторов в _calculate_opportunity_score():
     → Тренд: 0-2 points (достаточно?)
     → Индикаторы: 0-2 points (достаточно?)
     → Паттерны: 0-1 point
     → S/R: 0-1 point
     → Volume: 0-1 point
     → BTC Support: 0-1 point
     → Order Blocks: 0-1 point
     → FVG: 0-1 point
     → BOS/ChoCh: 0-1 point
     → R:R: 0-1 point
     → ADX: 0-1 point
     
     ИТОГО: 0-15 points
     
     Минимум для входа: 8.0/15
     Рекомендуется: 10.0+/15
     
4.2. Проверить не слишком ли строгие критерии:
     → Если score 7.5-7.9 → можно ли рассмотреть с warning?
     → Если BTC сильно поддерживает → можно ли +0.5 bonus?
     → Если exceptional setup → можно ли +1.0 bonus?
```

---

## 📊 ОБЯЗАТЕЛЬНЫЙ ПРОТОКОЛ АНАЛИЗА

### ПРАВИЛЬНЫЙ ПОРЯДОК ДЕЙСТВИЙ:

```
═══════════════════════════════════════
ШАГ 1: BTC + Market Overview (2 мин)
═══════════════════════════════════════

1.1. BTC анализ (ПЕРВЫМ):
     ✅ get_ticker("BTCUSDT", "spot")
     ✅ get_kline("BTCUSDT", "240", 50) // 4h
     ✅ get_ml_rsi("BTCUSDT", "60", "spot") // 1h
     ✅ get_market_structure("BTCUSDT", "240", "spot")
     
1.2. Market Overview:
     ✅ get_market_overview("spot") // Полный обзор
     ✅ get_market_info("spot", limit=500) // Максимум активов

═══════════════════════════════════════
ШАГ 2: ПАРАЛЛЕЛЬНЫЙ ПОИСК (3 мин)
═══════════════════════════════════════

2.1. LONG поиск (6 запросов ПАРАЛЛЕЛЬНО):
     ✅ scan_market({rsi_range: [0, 35], direction: "long"}, limit=50)
     ✅ scan_market({macd_crossover: "bullish", direction: "long"}, limit=50)
     ✅ scan_market({min_score: 7.0, direction: "long"}, limit=50)
     ✅ find_oversold_assets("spot", 1000000)
     ✅ find_breakout_opportunities("spot", 1000000)
     ✅ find_trend_reversals("spot", 1000000)
     
2.2. SHORT поиск (6 запросов ПАРАЛЛЕЛЬНО):
     ✅ scan_market({rsi_range: [65, 100], direction: "short"}, limit=50)
     ✅ scan_market({macd_crossover: "bearish", direction: "short"}, limit=50)
     ✅ scan_market({min_score: 7.0, direction: "short"}, limit=50)
     ✅ find_overbought_assets("spot", 1000000)
     ✅ find_breakout_opportunities("spot", 1000000) // Может быть SHORT
     ✅ find_trend_reversals("spot", 1000000) // Bearish reversal

ИТОГО: 12+ параллельных запросов → 200-500 активов

═══════════════════════════════════════
ШАГ 3: МНОГОУРОВНЕВАЯ ФИЛЬТРАЦИЯ (5 мин)
═══════════════════════════════════════

3.1. УРОВЕНЬ 1: Объединение и базовая фильтрация
     → Объединить все результаты
     → Убрать дубликаты
     → Фильтр: Volume >= $500K
     → ИТОГО: 200-500 активов
     
3.2. УРОВЕНЬ 2: Средний анализ
     → Для каждого: использовать score из scan_market
     → Если нет score → быстрый анализ
     → Фильтр: Score >= 6.0, Volume >= $1M
     → ИТОГО: 50-100 активов
     
3.3. УРОВЕНЬ 3: Детальный анализ
     → analyze_asset() для топ 50-100
     → Полный confluence scoring
     → Фильтр: Score >= 7.0, Probability >= 65%, R:R >= 1:2
     → ИТОГО: 20-30 активов

═══════════════════════════════════════
ШАГ 4: ФИНАЛЬНЫЙ ОТБОР (2 мин)
═══════════════════════════════════════

4.1. Ранжирование:
     → Отдельно для LONG и SHORT
     → Сортировать по score DESC
     
4.2. Отбор:
     → Топ 3 LONG (score >= 8.0, или лучшие до 3)
     → Топ 4 SHORT (score >= 8.0, или лучшие до 4)
     
4.3. Детальный анализ финальных кандидатов:
     → Для каждого из 3 LONG + 4 SHORT:
        - Полный multi-TF анализ
        - Все индикаторы
        - Паттерны
        - S/R уровни
        - Entry plan
        - Confluence scoring
        - Самопроверка (чеклист 17 пунктов)
```

---

## ✅ КРИТЕРИИ УСПЕХА

**Анализ считается успешным если:**

1. ✅ Проанализировано минимум 100 активов (лучше 200-500)
2. ✅ Использованы ВСЕ инструменты поиска (12+ запросов)
3. ✅ Найдено 3 LONG сигнала (score >= 8.0, или лучшие до 3)
4. ✅ Найдено 4 SHORT сигнала (score >= 8.0, или лучшие до 4)
5. ✅ Применена многоуровневая фильтрация
6. ✅ Каждый сигнал имеет:
   - Confluence score >= 8.0 (или >= 7.5 с объяснением)
   - Probability >= 70%
   - R:R >= 1:2
   - Полный entry plan
   - Самопроверка пройдена (15+/17 ✅)

**Если не найдено достаточно сигналов:**
- Объяснить почему (конкретные причины)
- Показать что было проанализировано (количество активов)
- Предложить что ждать для улучшения ситуации

---

## 🔍 ЧЕКЛИСТ ПРОВЕРКИ

**Перед завершением анализа проверить:**

```
[ ] BTC проанализирован первым?
[ ] Market overview получен (500+ активов)?
[ ] Запущены ВСЕ инструменты поиска (12+ запросов)?
[ ] Поиск в ОБЕ СТОРОНЫ (LONG и SHORT)?
[ ] Применена многоуровневая фильтрация?
[ ] Проанализировано минимум 100 активов?
[ ] Найдено 3 LONG сигнала?
[ ] Найдено 4 SHORT сигнала?
[ ] Каждый сигнал имеет score >= 8.0 (или >= 7.5)?
[ ] Каждый сигнал имеет полный entry plan?
[ ] Самопроверка пройдена для каждого сигнала?
```

**Если хоть один пункт НЕТ → анализ неполный!**

---

## 🎯 ФИНАЛЬНЫЙ ФОРМАТ ВЫВОДА

```
═══════════════════════════════════════
🎯 НАЙДЕННЫЕ ВОЗМОЖНОСТИ
═══════════════════════════════════════

📊 СТАТИСТИКА АНАЛИЗА:
- Проанализировано: 247 активов
- УРОВЕНЬ 1: 247 активов (volume >= $500K)
- УРОВЕНЬ 2: 78 активов (score >= 6.0)
- УРОВЕНЬ 3: 24 актива (score >= 7.0)
- Финальный отбор: 3 LONG + 4 SHORT

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📈 LONG ВОЗМОЖНОСТИ (Топ 3)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Детальный анализ каждого из 3 LONG]

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📉 SHORT ВОЗМОЖНОСТИ (Топ 4)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

[Детальный анализ каждого из 4 SHORT]
```

---

## 🚨 ЧТО ИСПРАВИТЬ СРОЧНО

1. **Обязательное использование всех инструментов**
   - Минимум 12 параллельных запросов
   - ВСЕГДА искать в ОБЕ СТОРОНЫ

2. **Многоуровневая фильтрация**
   - УРОВЕНЬ 1: 200-500 активов
   - УРОВЕНЬ 2: 50-100 активов
   - УРОВЕНЬ 3: 20-30 активов
   - ФИНАЛ: 3 LONG + 4 SHORT

3. **Обязательный поиск SHORT**
   - Минимум 4 SHORT сигнала
   - Использовать find_overbought_assets
   - scan_market с rsi_range [65, 100]

4. **Улучшение scoring**
   - Проверить веса факторов
   - Добавить bonus за exceptional setups
   - Не отбрасывать слишком рано (score 7.5-7.9 можно рассмотреть)

---

**Этот промпт должен использоваться для полного аудита и исправления системы!**

