# ðŸ”§ ÐŸÐ ÐžÐœÐŸÐ¢: Ð£Ð¡Ð¢Ð ÐÐÐ•ÐÐ˜Ð• Ð¡Ð›ÐÐ‘Ð«Ð¥ ÐœÐ•Ð¡Ð¢ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ« Ð¢Ð Ð•Ð™Ð”Ð˜ÐÐ“Ð

## ÐšÐžÐÐ¢Ð•ÐšÐ¡Ð¢

ÐÐ° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð°ÑƒÐ´Ð¸Ñ‚Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹ Ñ‚Ñ€ÐµÐ¹Ð´Ð¸Ð½Ð³Ð° Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹ ÐšÐ Ð˜Ð¢Ð˜Ð§Ð•Ð¡ÐšÐ˜Ð• ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² ÐºÐ¾Ð´Ðµ `mcp_server/market_scanner.py` Ð¸ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð¾Ñ€ÐµÑ‡Ð¸Ñ Ð² Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ð°Ñ…. ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð²Ð½ÐµÑÑ‚Ð¸ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±ÐµÑÐ¿ÐµÑ‡ÐµÐ½Ð¸Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ ÐºÐ°Ð¿Ð¸Ñ‚Ð°Ð»Ð° Ð¸ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ÑÑ‚Ð¸ Ð»Ð¾Ð³Ð¸ÐºÐ¸.

## ÐŸÐ Ð˜ÐžÐ Ð˜Ð¢Ð•Ð¢Ð« Ð—ÐÐ”ÐÐ§

### ðŸ”´ ÐŸÐ Ð˜ÐžÐ Ð˜Ð¢Ð•Ð¢ 1: Ð˜ÑÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ `mcp_server/market_scanner.py`

ÐÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð¸ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼Ñ‹ Ð² ÐºÐ¾Ð´Ðµ:

1.  **Hardcoded Account Balance**: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ `ACCOUNT_BALANCE = 30.0`.
    *   *Ð ÐµÑˆÐµÐ½Ð¸Ðµ:* Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¼ÐµÑ‚Ð¾Ð´ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð±Ð°Ð»Ð°Ð½ÑÐ° Ñ‡ÐµÑ€ÐµÐ· `get_wallet_balance` Ð¸Ð»Ð¸ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ ÐºÐ°Ðº Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€. Ð•ÑÐ»Ð¸ API Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ fallback Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ, Ð½Ð¾ ÐÐ• hardcoded $30 Ð´Ð»Ñ Ð²ÑÐµÑ…. Ð›ÑƒÑ‡ÑˆÐµ Ð·Ð°Ð¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ Ð¿Ñ€Ð¸ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ.
    
2.  **Fake R:R Scoring**: Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ `rr_score = 1.0`.
    *   *Ð ÐµÑˆÐµÐ½Ð¸Ðµ:* Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ `entry_plan` (SL/TP), Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°Ñ‚ÑŒ R:R, Ð¸ Ð¢ÐžÐ›Ð¬ÐšÐž ÐŸÐžÐ¢ÐžÐœ ÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Score Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ R:R. ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð·Ð¾Ð² `_generate_entry_plan` Ð”Ðž `_calculate_opportunity_score` Ð¸Ð»Ð¸ Ð²Ñ‹Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÐµÐ³Ð¾ Ð²Ð½ÑƒÑ‚Ñ€Ð¸ scoring.

3.  **Hardcoded Risk**: Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ Ñ€Ð¸ÑÐº (0.02) Ð½Ð°ÑÑ‚Ñ€Ð°Ð¸Ð²Ð°ÐµÐ¼Ñ‹Ð¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð¾Ð¼ Ð¼ÐµÑ‚Ð¾Ð´Ð°.

### ðŸŸ  ÐŸÐ Ð˜ÐžÐ Ð˜Ð¢Ð•Ð¢ 2: Ð£ÑÑ‚Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ ÐŸÑ€Ð¾Ñ‚Ð¸Ð²Ð¾Ñ€ÐµÑ‡Ð¸Ð¹ "Spot vs Linear"

1.  **ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ `prompts/market_analysis_protocol_optimized.md`**:
    *   Ð—Ð°Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²ÑÐµ Ð²Ñ‹Ð·Ð¾Ð²Ñ‹ `get_market_info("linear")` Ð½Ð° `get_market_info("spot")` (ÑÐ¾Ð³Ð»Ð°ÑÐ½Ð¾ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¸Ñ‡ÐºÐ°).
    *   Ð¯Ð²Ð½Ð¾ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ, Ñ‡Ñ‚Ð¾ Ð´Ð»Ñ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð° $30 Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ **Spot**.

2.  **ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ `prompts/agent_core_instructions.md`**:
    *   Ð£Ð±Ñ€Ð°Ñ‚ÑŒ ÑƒÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ ÑÑ‚Ð°Ñ€Ð¾Ð³Ð¾ `prompts/market_analysis_protocol.md`.
    *   ÐžÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ Ð¢ÐžÐ›Ð¬ÐšÐž Ð½Ð° `prompts/market_analysis_protocol_optimized.md`.

## Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð˜ ÐŸÐž Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð® ÐšÐžÐ”Ð (Python)

### Ð¤Ð°Ð¹Ð»: `mcp_server/market_scanner.py`

**Ð—Ð°Ð´Ð°Ñ‡Ð° 1: Ð”Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð‘Ð°Ð»Ð°Ð½Ñ Ð¸ Ð Ð¸ÑÐº**
Ð˜Ð·Ð¼ÐµÐ½Ð¸ ÑÐ¸Ð³Ð½Ð°Ñ‚ÑƒÑ€Ñƒ `scan_market` Ð¸ `_generate_entry_plan` Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ `account_balance` Ð¸ `risk_percent`.

```python
# Ð‘Ñ‹Ð»Ð¾
def _generate_entry_plan(self, analysis: Dict, ticker: Dict) -> Dict[str, Any]:
    # ...
    ACCOUNT_BALANCE = 30.0 # HARDCODED!
    MAX_RISK_PCT = 0.02    # HARDCODED!
    # ...

# Ð¡Ñ‚Ð°Ð»Ð¾ (ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ð¾)
def _generate_entry_plan(self, analysis: Dict, ticker: Dict, account_balance: float = 30.0, risk_percent: float = 0.02) -> Dict[str, Any]:
    # ... Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚Ñ‹ ...
```

Ð’ `scan_market` Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑˆÐ°Ð³ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ° (ÐµÑÐ»Ð¸ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾) Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½Ð½Ñ‹Ð¹.

**Ð—Ð°Ð´Ð°Ñ‡Ð° 2: Ð ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ R:R Score**
Ð’ Ð¼ÐµÑ‚Ð¾Ð´Ðµ `_calculate_opportunity_score`:
1. Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Entry/SL/TP (Ð¼Ð¾Ð¶Ð½Ð¾ Ð²Ñ‹Ð·Ð²Ð°Ñ‚ÑŒ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¸Ð· `_generate_entry_plan` Ð¸Ð»Ð¸ Ð²Ñ‹Ð½ÐµÑÑ‚Ð¸ ÐµÑ‘ Ð² Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ð¹ helper).
2. Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ R:R.
3. ÐŸÑ€Ð¸ÑÐ²Ð°Ð¸Ð²Ð°Ñ‚ÑŒ Ð±Ð°Ð»Ð»Ñ‹:
   - R:R >= 1:3 â†’ 1.0 Ð±Ð°Ð»Ð»
   - R:R >= 1:2 â†’ 0.5 Ð±Ð°Ð»Ð»Ð°
   - R:R < 1:2 â†’ 0 Ð±Ð°Ð»Ð»Ð¾Ð²

## Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð˜ ÐŸÐž ÐžÐ‘ÐÐžÐ’Ð›Ð•ÐÐ˜Ð® ÐŸÐ ÐžÐœÐŸÐ¢ÐžÐ’

### Ð¤Ð°Ð¹Ð»: `prompts/market_analysis_protocol_optimized.md`

1.  Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ `get_market_overview("linear", ...)` Ð½Ð° `get_market_overview("spot", ...)`.
2.  Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ `get_ticker(..., "linear")` Ð½Ð° `get_ticker(..., "spot")`.
3.  Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ðµ: "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Spot Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð¿Ñ€Ð¸ Ð¼Ð°Ð»Ð¾Ð¼ Ð´ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ðµ".

### Ð¤Ð°Ð¹Ð»: `prompts/agent_core_instructions.md`

1.  Ð’ ÑÐµÐºÑ†Ð¸Ð¸ "Ð¢Ð²Ð¾Ð¹ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°" (Ð¿ÑƒÐ½ÐºÑ‚ 2) ÑƒÐ±Ñ€Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚ "ÐžÐŸÐ¢Ð˜ÐœÐ˜Ð—Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð™ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°..." Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð½Ð°Ð¿Ð¸ÑÐ°Ñ‚ÑŒ: "2. Ð¡Ð»ÐµÐ´ÑƒÐ¹ Ð¿Ñ€Ð¾Ñ‚Ð¾ÐºÐ¾Ð»Ñƒ Ð² `prompts/market_analysis_protocol_optimized.md`".
2.  Ð£Ð±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ Ð¿Ð¾ Spot ÑÐ¾Ð³Ð»Ð°ÑÑƒÑŽÑ‚ÑÑ.

## ÐŸÐžÐ Ð¯Ð”ÐžÐš Ð’Ð«ÐŸÐžÐ›ÐÐ•ÐÐ˜Ð¯

1.  Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð¸ÑÐ¿Ñ€Ð°Ð²ÑŒ Python ÐºÐ¾Ð´ (Logic Fixes).
2.  Ð—Ð°Ñ‚ÐµÐ¼ Ð¾Ð±Ð½Ð¾Ð²Ð¸ Markdown Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚Ñ‹ (Consistency Fixes).
3.  ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒ, Ñ‡Ñ‚Ð¾ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ðµ ÑƒÐ¿Ð°Ð´ÑƒÑ‚ (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹ Ð½Ð° ÑÑ‚Ð¾Ñ‚ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»).

## ÐšÐ Ð˜Ð¢Ð•Ð Ð˜Ð˜ Ð“ÐžÐ¢ÐžÐ’ÐÐžÐ¡Ð¢Ð˜

- [ ] Ð’ `market_scanner.py` Ð½ÐµÑ‚ Ñ…Ð°Ñ€Ð´ÐºÐ¾Ð´Ð° `$30`.
- [ ] R:R score Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ñ‡ÐµÑÑ‚Ð½Ð¾.
- [ ] ÐŸÑ€Ð¾Ð¼Ð¿Ñ‚Ñ‹ ÑÐ¾Ð³Ð»Ð°ÑÐ¾Ð²Ð°Ð½Ñ‹ (Ð²ÐµÐ·Ð´Ðµ Spot Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‚Ð°).
- [ ] Ð Ð¸ÑÐº-Ð¼ÐµÐ½ÐµÐ´Ð¶Ð¼ÐµÐ½Ñ‚ ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð±Ð°Ð»Ð°Ð½Ñ.
