#!/usr/bin/env python3
"""
ะกะบัะธะฟั ะดะปั ะพัะฟัะฐะฒะบะธ ัะพัะณะพะฒะพะณะพ ัะธะณะฝะฐะปะฐ ะฒ Telegram ะณััะฟะฟั
"""
import asyncio
import sys
from pathlib import Path

# ะะพะฑะฐะฒะปัะตะผ ะฟััั ะบ mcp_server
sys.path.insert(0, str(Path(__file__).parent))

from mcp_server.telegram_bot import TelegramBot, send_trading_signal


# ะขะพะบะตะฝ ะฑะพัะฐ
BOT_TOKEN = "8003689195:AAGxQsopKvlLS34H2TZ0S1a0K7s4yV4iOBY"

# ะกะพะพะฑัะตะฝะธะต ะดะปั ะพัะฟัะฐะฒะบะธ (ะบัะฐัะธะฒะพ ะพัะพัะผะปะตะฝะฝะพะต)
TRADING_SIGNAL_MESSAGE = """<b>โก ะะะขะะะฌะะซะ ะะะะ ะกะะะะะ</b>

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>

<b>๐ ะกะะะะะ #1: ZEN/USDT</b>

<b>Entry:</b> $15.89
<b>Stop-Loss:</b> $13.58
<b>Take-Profit:</b> $20.52

<b>Risk/Reward:</b> 1:2.0

<b>Position Size:</b> ะะฐัััะธัะฐัั ะฝะฐ ะพัะฝะพะฒะต ะฒะฐัะตะณะพ ะดะตะฟะพะทะธัะฐ:

โข <b>ะะธัะบ ะฝะฐ ัะดะตะปะบั:</b> 1-2% ะพั ะดะตะฟะพะทะธัะฐ (ัะตะบะพะผะตะฝะดัะตััั 1%)
โข <b>ะะฐัััั:</b> (ะะฐั ัะธัะบ ะฒ $) / (Entry - SL = $2.31) = ะบะพะปะธัะตััะฒะพ ZEN
โข <b>ะัะธะผะตั:</b> ะัะธ ัะธัะบะต 1% ะธ ะดะตะฟะพะทะธัะต $X โ ัะธัะบ = $X ร 0.01 โ Position size = ัะธัะบ / $2.31

<b>โฐ Safe Time Window:</b> 12-18 ัะฐัะพะฒ
<b>โฑ๏ธ ะะฐะบัะธะผัะผ:</b> 24 ัะฐัะฐ

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>

<b>๐ ะกะะะะะ #2: XPL/USDT</b>

<b>Entry:</b> $0.240
<b>Stop-Loss:</b> $0.210
<b>Take-Profit:</b> $0.300

<b>Risk/Reward:</b> 1:2.0

<b>Position Size:</b> ะะฐัััะธัะฐัั ะฝะฐ ะพัะฝะพะฒะต ะฒะฐัะตะณะพ ะดะตะฟะพะทะธัะฐ:

โข <b>ะะธัะบ ะฝะฐ ัะดะตะปะบั:</b> 1-2% ะพั ะดะตะฟะพะทะธัะฐ (ัะตะบะพะผะตะฝะดัะตััั 1%)
โข <b>ะะฐัััั:</b> (ะะฐั ัะธัะบ ะฒ $) / (Entry - SL = $0.030) = ะบะพะปะธัะตััะฒะพ XPL
โข <b>ะัะธะผะตั:</b> ะัะธ ัะธัะบะต 1% ะธ ะดะตะฟะพะทะธัะต $X โ ัะธัะบ = $X ร 0.01 โ Position size = ัะธัะบ / $0.030

<b>โฐ Safe Time Window:</b> 8-12 ัะฐัะพะฒ
<b>โฑ๏ธ ะะฐะบัะธะผัะผ:</b> 18 ัะฐัะพะฒ

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>

<b>๐ ะกะะะะะ #3: MINA/USDT</b>

<b>Entry:</b> $0.143
<b>Stop-Loss:</b> $0.120
<b>Take-Profit:</b> $0.190

<b>Risk/Reward:</b> 1:2.04

<b>Position Size:</b> ะะฐัััะธัะฐัั ะฝะฐ ะพัะฝะพะฒะต ะฒะฐัะตะณะพ ะดะตะฟะพะทะธัะฐ:

โข <b>ะะธัะบ ะฝะฐ ัะดะตะปะบั:</b> 1-2% ะพั ะดะตะฟะพะทะธัะฐ (ัะตะบะพะผะตะฝะดัะตััั 1%)
โข <b>ะะฐัััั:</b> (ะะฐั ัะธัะบ ะฒ $) / (Entry - SL = $0.023) = ะบะพะปะธัะตััะฒะพ MINA
โข <b>ะัะธะผะตั:</b> ะัะธ ัะธัะบะต 1% ะธ ะดะตะฟะพะทะธัะต $X โ ัะธัะบ = $X ร 0.01 โ Position size = ัะธัะบ / $0.023

<b>โฐ Safe Time Window:</b> 8-12 ัะฐัะพะฒ
<b>โฑ๏ธ ะะฐะบัะธะผัะผ:</b> 16 ัะฐัะพะฒ

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>

<b>๐ฐ ะะะฉะะ ะะะกะ ะะะะขะคะะะฏ</b>

ะัะปะธ ะพัะบัััั ะฒัะต 3 ะฟะพะทะธัะธะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพ:

โข <b>ะะฑัะธะน ัะธัะบ:</b> 3-6% ะพั ะดะตะฟะพะทะธัะฐ (ะฟัะธ ัะธัะบะต 1-2% ะฝะฐ ัะดะตะปะบั)
โข <b>ะะตะบะพะผะตะฝะดะฐัะธั:</b> ะะต ะฟัะตะฒััะฐัั 5% ะพะฑัะตะณะพ ัะธัะบะฐ ะฟะพัััะตะปั
โข <b>ะะฐะบัะธะผัะผ ะฟะพะทะธัะธะน:</b> 2-3 ะพะดะฝะพะฒัะตะผะตะฝะฝะพ (ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะฐะทะผะตัะฐ ะดะตะฟะพะทะธัะฐ)

<b>ะคะพัะผัะปะฐ ะดะปั ัะฐััััะฐ:</b>
<code>ะะฑัะธะน ัะธัะบ = (ะะธัะบ ะฝะฐ ัะดะตะปะบั %) ร (ะะพะปะธัะตััะฒะพ ะฟะพะทะธัะธะน)
ะัะธะผะตั: 1% ร 3 = 3% ะพะฑัะตะณะพ ัะธัะบะฐ</code>

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>

<b>๐ฏ CONFIDENCE ะ ะะะะะะะ: 8.0/10</b>

ะัะต 3 ะฐะบัะธะฒะฐ:

โ Outperforming BTC ะฝะฐ 10-27%
โ Multi-TF alignment bullish
โ R:R โฅ 1:2
โ Probability โฅ 95%
โ ะฅะพัะพัะฐั ะปะธะบะฒะธะดะฝะพััั

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>

<b>๐ค ะะขะะะซะะะขะฌ?</b>

<b>ะะพั ัะตะบะพะผะตะฝะดะฐัะธั:</b> ะะ, ะฝะพ ั ะพััะพัะพะถะฝะพัััั

<b>ะะพัะตะผั:</b>

1๏ธโฃ BTC ะฒ ะผะตะดะฒะตะถัะตะผ ััะตะฝะดะต โ ะพัะฝะพะฒะฝะพะน ัะธัะบ
2๏ธโฃ ะัะต 3 ะฐะบัะธะฒะฐ outperforming BTC โ ะฟะพะบะฐะทัะฒะฐะตั ัะธะปั
3๏ธโฃ Confluence โฅ 7.0/10 ะดะปั ะฒัะตั
4๏ธโฃ R:R โฅ 1:2 ะดะปั ะฒัะตั
5๏ธโฃ Probability โฅ 95% ะดะปั ะฒัะตั

<b>ะกััะฐัะตะณะธั ะฒัะพะดะฐ:</b>

๐ฏ ะะฐัะฐัั ั <b>ZEN/USDT</b> (ะปัััะธะน confluence 8.0/10)
๐ฏ ะะฐัะตะผ <b>XPL/USDT</b> (ะพัะปะธัะฝะฐั ะปะธะบะฒะธะดะฝะพััั)
๐ฏ <b>MINA/USDT</b> โ ัะพะปัะบะพ ะตัะปะธ ะฟะตัะฒัะต 2 ัะฐะฑะพัะฐัั

<b>โ๏ธ ะะฐะถะฝะพ:</b>

โข ะะพะฝะธัะพัะธัั BTC ะบะฐะถะดัะต 30-60 ะผะธะฝัั
โข Exit ะฟัะธ ะฟะตัะฒัั ะฟัะธะทะฝะฐะบะฐั ัะปะฐะฑะพััะธ BTC
โข ะะต ะฟัะตะฒััะฐัั safe time window
โข ะัะฟะพะปัะทะพะฒะฐัั ัะธัะบ 1-2% ะฝะฐ ัะดะตะปะบั (ะฝะต ะฑะพะปะตะต 5% ะพะฑัะตะณะพ ัะธัะบะฐ ะฟะพัััะตะปั)

<b>โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ</b>"""


# Chat ID ะบะฐะฝะฐะปะฐ ะฟะพ ัะผะพะปัะฐะฝะธั (DIAMOND HEADZH)
DEFAULT_CHANNEL_ID = "-1003382613825"

async def get_chat_id_interactive():
    """ะะฝัะตัะฐะบัะธะฒะฝะพ ะฟะพะปััะธัั chat_id ะณััะฟะฟั ะธะปะธ ะบะฐะฝะฐะปะฐ"""
    bot = TelegramBot(BOT_TOKEN)
    
    print("๐ ะะพะปััะตะฝะธะต ะพะฑะฝะพะฒะปะตะฝะธะน ะพั ะฑะพัะฐ...")
    print("๐ ะะพะถะฐะปัะนััะฐ, ะพัะฟัะฐะฒััะต ะปัะฑะพะต ัะพะพะฑัะตะฝะธะต ะฒ ะณััะฟะฟั/ะบะฐะฝะฐะป, ะณะดะต ะฝะฐัะพะดะธััั ะฑะพั...")
    print("โณ ะะถะธะดะฐะฝะธะต 10 ัะตะบัะฝะด...\n")
    
    try:
        result = await bot.get_updates(timeout=10)
        updates = result.get("result", [])
        
        if not updates:
            print(f"โ ะะตั ะพะฑะฝะพะฒะปะตะฝะธะน. ะัะฟะพะปัะทัะตััั ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั: {DEFAULT_CHANNEL_ID}")
            return DEFAULT_CHANNEL_ID
        
        print("๐ ะะฐะนะดะตะฝะฝัะต ัะฐัั/ะณััะฟะฟั/ะบะฐะฝะฐะปั:\n")
        chat_ids = {}
        
        for update in updates:
            # ะัะพะฒะตััะตะผ channel_post ะดะปั ะบะฐะฝะฐะปะพะฒ
            if "channel_post" in update:
                chat = update["channel_post"].get("chat", {})
                chat_id = chat.get("id")
                chat_type = chat.get("type")
                chat_title = chat.get("title", "Unknown")
                
                if chat_id and chat_type == "channel":
                    chat_ids[chat_id] = {
                        "title": chat_title,
                        "type": chat_type
                    }
            
            # ะัะพะฒะตััะตะผ message ะดะปั ะณััะฟะฟ ะธ ะปะธัะฝัั ัะฐัะพะฒ
            if "message" in update:
                chat = update["message"].get("chat", {})
                chat_id = chat.get("id")
                chat_type = chat.get("type")
                chat_title = chat.get("title") or chat.get("first_name", "Unknown")
                
                if chat_id and chat_type in ["group", "supergroup", "channel"]:
                    chat_ids[chat_id] = {
                        "title": chat_title,
                        "type": chat_type
                    }
        
        if not chat_ids:
            print(f"โ ะงะฐัั ะฝะต ะฝะฐะนะดะตะฝั. ะัะฟะพะปัะทัะตััั ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั: {DEFAULT_CHANNEL_ID}")
            return DEFAULT_CHANNEL_ID
        
        print("โ ะะฐะนะดะตะฝะฝัะต ัะฐัั:\n")
        for idx, (chat_id, info) in enumerate(chat_ids.items(), 1):
            print(f"  {idx}. {info['title']} ({info['type']})")
            print(f"     CHAT_ID: {chat_id}\n")
        
        if len(chat_ids) == 1:
            selected_id = list(chat_ids.keys())[0]
            print(f"โ ะัะฟะพะปัะทัะตััั ะตะดะธะฝััะฒะตะฝะฝัะน ะฝะฐะนะดะตะฝะฝัะน ัะฐั: {chat_ids[selected_id]['title']}")
            return selected_id
        else:
            print("ะัะฑะตัะธัะต ะฝะพะผะตั ัะฐัะฐ (ะธะปะธ ะฒะฒะตะดะธัะต chat_id ะฒัััะฝัั):")
            choice = input("> ").strip()
            
            try:
                idx = int(choice) - 1
                if 0 <= idx < len(chat_ids):
                    selected_id = list(chat_ids.keys())[idx]
                    return selected_id
            except ValueError:
                pass
            
            # ะะพะฟัะพะฑะพะฒะฐัั ะบะฐะบ chat_id
            if choice in chat_ids:
                return choice
            
            print(f"โ ะะตะฒะตัะฝัะน ะฒัะฑะพั. ะัะฟะพะปัะทัะตััั ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั: {DEFAULT_CHANNEL_ID}")
            return DEFAULT_CHANNEL_ID
            
    except Exception as e:
        print(f"โ ะัะธะฑะบะฐ: {e}")
        print(f"ะัะฟะพะปัะทัะตััั ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั: {DEFAULT_CHANNEL_ID}")
        return DEFAULT_CHANNEL_ID
    finally:
        await bot.close()


async def send_message(chat_id: str):
    """ะัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต ะฒ ะณััะฟะฟั/ะบะฐะฝะฐะป"""
    print(f"\n๐ค ะัะฟัะฐะฒะบะฐ ัะพะพะฑัะตะฝะธั ะฒ ัะฐั (CHAT_ID: {chat_id})...\n")
    
    success = await send_trading_signal(BOT_TOKEN, chat_id, TRADING_SIGNAL_MESSAGE)
    
    if success:
        print("โ ะกะพะพะฑัะตะฝะธะต ััะฟะตัะฝะพ ะพัะฟัะฐะฒะปะตะฝะพ!")
    else:
        print("โ ะะต ัะดะฐะปะพัั ะพัะฟัะฐะฒะธัั ัะพะพะฑัะตะฝะธะต")
        sys.exit(1)


async def main():
    """ะะปะฐะฒะฝะฐั ััะฝะบัะธั"""
    if len(sys.argv) > 1:
        # CHAT_ID ะฟะตัะตะดะฐะฝ ะบะฐะบ ะฐัะณัะผะตะฝั
        chat_id = sys.argv[1]
        await send_message(chat_id)
    else:
        # ะัะฟะพะปัะทัะตะผ ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั ะธะปะธ ะธะฝัะตัะฐะบัะธะฒะฝัะน ัะตะถะธะผ
        print("=" * 60)
        print("๐ค Telegram Bot - ะัะฟัะฐะฒะบะฐ ัะพัะณะพะฒะพะณะพ ัะธะณะฝะฐะปะฐ")
        print("=" * 60)
        print()
        
        # ะัะพะฑัะตะผ ะธัะฟะพะปัะทะพะฒะฐัั ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั
        print(f"๐ก ะัะฟะพะปัะทัะตััั ะบะฐะฝะฐะป ะฟะพ ัะผะพะปัะฐะฝะธั: {DEFAULT_CHANNEL_ID}")
        print("   (ะะปั ะธะฝัะตัะฐะบัะธะฒะฝะพะณะพ ะฒัะฑะพัะฐ ะทะฐะฟัััะธัะต: python send_telegram_post.py interactive)\n")
        
        await send_message(DEFAULT_CHANNEL_ID)


if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nโ๏ธ ะัะตัะฒะฐะฝะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะผ")
        sys.exit(0)
    except Exception as e:
        print(f"\nโ ะัะธัะธัะตัะบะฐั ะพัะธะฑะบะฐ: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

